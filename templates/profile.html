<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8" />
    <title>Aira | Update Profile</title>

    <link rel="shortcut icon" type="image/x-icon" href="{{ url_for('static', filename='images/favicon.png') }}">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap" rel="stylesheet">

    <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='css/profile-styles.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

</head>
<body>

    <div class="fallback-container">
        <i class="fa-solid fa-circle-exclamation"></i>
        <h1>Oops, We are sorry, but the website is not made responsive yet. Kindly visit us in a Laptop/PC.</h1>
    </div>
    
    <div class="loading" id="pre"><div class="lds-ellipsis"><div></div><div></div><div></div><div></div></div></div>

    <div class="loading" id="post">
        <div id="notifystatus">
            <h3 id="status"></h3>
            <button id="closenote" onclick="redirect('home')">Close and continue to Home</button>
        </div>
    </div>

    <div id="container">

        <div id="menu">
            <button id="close-menu" onclick="closemenu()">
                <svg xmlns="http://www.w3.org/2000/svg" height="48px" viewBox="0 -960 960 960" width="48px" fill="#F97300"><path d="m249-207-42-42 231-231-231-231 42-42 231 231 231-231 42 42-231 231 231 231-42 42-231-231-231 231Z"/></svg>
            </button>
            <h1>Menu</h1>
            <button class="menu-button" onclick="redirect('home')">Home</button>
            <button class="menu-button" onclick="redirect('currentprofile')">Current Profile</button>
            <button class="menu-button" onclick="redirect('profile')">Update Profile</button>
            <button class="menu-button" onclick='redirectToURL("https://github.com/thepropotato/Aira")'>View Source</button>
            <button class="menu-button" onclick="redirect('about')">About Aira</button>
        </div>

        <header>
            <p id="logo"><b>Aira</b></p>
            <button id="open-menu" onclick="openmenu()">
                <svg xmlns="http://www.w3.org/2000/svg" height="48px" viewBox="0 -960 960 960" width="48px" fill="#F97300"><path d="M120-240v-80h720v80H120Zm0-200v-80h720v80H120Zm0-200v-80h720v80H120Z"/></svg>
            </button>
        </header>

        <div class="details">
            <form id="profile-form">
                <div class="information">
                    <h1 class="section"><div>Personal Information<span>*</span></div></h1>
                    <input name="fullname" placeholder="Full Name" required>

                    <br><br><hr>

                    <h1 class="section"><div>Socials<span>*</span></div></h1>
                    <input name="linkedin" placeholder="Linkedin URL" required>
                    <input name="github" placeholder="Github URL" required>
                    <input name="mail" placeholder="Mail ID" required>
                    <input name="contact" placeholder="Contact Number" required>
                    <input name="website" placeholder="Website URL (Optional)">

                    <br><br><hr>

                    <h1 class="section">Objective</h1>
                    <input name="objective" placeholder="This will be generated by AI. You can always edit it if you want to. (AI will write only if you leave this empty)">

                    <br><br><hr>

                    <h1 class="section"><div>Education<span>*</span></div> <button type="button" class="add-attribute" onclick="addEducation()"><i class="fa-solid fa-plus"></i></button></h1>
                    <div id="education">
                        <div id="education-set">
                            <input name="institution" placeholder="Institution" class="input-data" required>
                            <input name="qualification" placeholder="Qualification" class="input-data" required>
                            <input name="grade" placeholder="Grade" class="input-data" required>
                            <input name="time" placeholder="Time period (Ex: 20xx - 20yy)" class="input-data" required>
                        </div>
                    </div>

                    <br><hr>

                    <h1 class="section"><div>Projects<span>*</span></div><button type="button" class="add-attribute" onclick="addProject()"><i class="fa-solid fa-plus"></i></button></h1>
                    <div id="projects">
                        <div id="project-set">
                            <input name="project_title" placeholder="Project Title" class="input-data" required>
                            <input name="desc" placeholder="Explain the project in 2 lines" class="input-data" required>
                            <input name="tech" placeholder="Technologies used" class="input-data" required>
                        </div>
                    </div>

                    <br><hr>

                    <h1 class="section">Publications<button type="button" class="add-attribute" onclick="addPublication()"><i class="fa-solid fa-plus"></i></button></h1>
                    <div id="publications">
                        <div id="publication-set">
                            <input name="publication" placeholder="Write clearly about your work. (In standard format)" class="input-data">
                        </div>
                    </div>

                    <br><hr>

                    <h1 class="section"><div>Skills<span>*</span></div><button type="button" class="add-attribute" onclick="addSkill()"><i class="fa-solid fa-plus"></i></button></h1>
                    <div id="skill">
                        <div id="skill-set">
                            <input name="skill" placeholder="Skill" class="input-data" required>
                        </div>
                    </div>

                    <br><hr>

                    <h1 class="section"><div>Languages<span>*</span></div><button type="button" class="add-attribute" onclick="addLanguage()"><i class="fa-solid fa-plus"></i></button></h1>
                    <div id="language">
                        <div id="language-set">
                            <input name="language" placeholder="Languages & Technologies" class="input-data" required>
                        </div>
                    </div>

                    <br><hr>

                    <h1 class="section">Achievements<button type="button" class="add-attribute" onclick="addAchievements()"><i class="fa-solid fa-plus"></i></button></h1>
                    <div id="achievements">
                        <div id="achievements-set">
                            <input name="achievement" placeholder="Achievement" class="input-data">
                        </div>
                    </div>

                    <br><hr>

                    <h1 class="section"><div>Course Work<span>*</span></div></h1>
                    <div id="coursework">
                        <div id="coursework-set">
                            <input name="courses" placeholder="Enter the comma seperated values of the course you have taken." class="input-data" required>
                        </div>
                    </div>

                    <br><hr>

                    <h1 class="section">Additional Engagements<button type="button" class="add-attribute" onclick="addAdditional()"><i class="fa-solid fa-plus"></i></button></h1>
                    <div id="additional-engagements">
                        <div id="additional-engagements-set">
                            <input name="additional" placeholder="Enter an additional engagement" class="input-data">
                        </div>
                    </div>

                    <br><hr>

                    <h1 class="section">Work Experience<button type="button" class="add-attribute" onclick="addWorkExperience()"><i class="fa-solid fa-plus"></i></button></h1>
                    <div id="experience">
                        <div id="experience-set">
                            <input name="experience" placeholder="Experience" class="input-data">
                        </div>
                    </div>

                    <br><hr>

                    <h1 class="section">Certifications<button type="button" class="add-attribute" onclick="addCertification()"><i class="fa-solid fa-plus"></i></button></h1>
                    <div id="certifications">
                        <div id="certification-set">
                            <input name="certification" placeholder="Certification" class="input-data">
                        </div>
                    </div>
                    <br><hr>

                    <h1 class="section"><div>Hobbies & Interests<span>*</span></div></h1>
                    <div id="hobbies">
                        <input name="hobbies" placeholder="Enter your Hobbies and Interests as comma separated values" class="input-data" required>
                    </div>
                    <br><hr>
                    
                    <div id="save-div">
                        <button type="submit" id="save">Save Information</button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <script>
        window.onload = setInputWidth;

        function setInputWidth() {
            var inputs = document.querySelectorAll('input');
            inputs.forEach(function(input) {
                var placeholderText = input.getAttribute('placeholder');
                var testElement = document.createElement('span');
                testElement.style.whiteSpace = 'nowrap';
                testElement.style.fontFamily = getComputedStyle(input).fontFamily;
                testElement.style.fontSize = getComputedStyle(input).fontSize;
                testElement.textContent = placeholderText;

                document.body.appendChild(testElement);
                var placeholderWidth = testElement.offsetWidth;
                document.body.removeChild(testElement);

                var defaultWidth = input.offsetWidth;
                var finalWidth = Math.max(defaultWidth, placeholderWidth + 10);
                input.style.width = finalWidth + 'px';
            });
        }

        function openmenu() {
            var menu = document.getElementById('menu');
            menu.style.right = '10px';
        }

        function closemenu() {
            var menu = document.getElementById('menu');
            menu.style.right = 'calc(-30% - 10px)';
        }

        function redirect(page) {
            fetch('/redirect', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ page: page })
            })
            .then(response => {
                if (response.redirected) {
                    window.location.href = response.url;
                }
            })
            .catch(error => {
                console.error('Error:', error);
            });
        }

        function redirectToURL(url) {
            window.open(url, "_blank");
        }

        // --------------------------------------------------------- 


        function getFormDataAsJson() {
            const form = document.getElementById('profile-form');
            const formData = new FormData(form);

            const information = {
                fullname: formData.get('fullname'),
                socials: {
                    linkedin: formData.get('linkedin'),
                    github: formData.get('github'),
                    mail: formData.get('mail'),
                    contact: formData.get('contact'),
                    website: formData.get('website')
                },
                objective: formData.get('objective'),
                education: [],
                projects: [],
                publications: [],
                skills: [],
                languages: [],
                achievements: [],
                course_work: formData.get('courses'),
                additionals: [],
                work_experiences: [],
                certifications: [],
                hobbies: formData.get('hobbies')
            };

            document.querySelectorAll('#education-set').forEach(set => {
                const institution = set.querySelector('[name="institution"]').value;
                const qualification = set.querySelector('[name="qualification"]').value;
                const grade = set.querySelector('[name="grade"]').value;
                const time = set.querySelector('[name="time"]').value;

                information.education.push({
                    institution: institution,
                    qualification: qualification,
                    grade: grade,
                    time: time
                });
            });

            document.querySelectorAll('#project-set').forEach(set => {
                const project_title = set.querySelector('[name="project_title"]').value;
                const desc = set.querySelector('[name="desc"]').value;
                const tech = set.querySelector('[name="tech"]').value;

                information.projects.push({
                    project_title: project_title,
                    desc: desc,
                    tech: tech
                });
            });

            document.querySelectorAll('#publication-set').forEach(set => {
                const publication = set.querySelector('[name="publication"]').value;
                if (publication != "") {
                    information.publications.push({
                        publication: publication,
                    });
                }
            });

            document.querySelectorAll('#skill-set').forEach(set => {
                const skill = set.querySelector('[name="skill"]').value;
                information.skills.push(skill);
            });

            document.querySelectorAll('#language-set').forEach(set => {
                const language = set.querySelector('[name="language"]').value;
                information.languages.push(language);
            });

            document.querySelectorAll('#achievements-set').forEach(set => {
                const achievement = set.querySelector('[name="achievement"]').value;
                if (achievement != "") {
                    information.achievements.push(achievement);
                }
            });

            document.querySelectorAll('#additional-engagements-set').forEach(set => {
                const additional = set.querySelector('[name="additional"]').value;
                if (additional != "") {
                    information.additionals.push(additional);
                }
            });

            document.querySelectorAll('#experience-set').forEach(set => {
                const experience = set.querySelector('[name="experience"]').value;
                if (experience != "") {
                    information.work_experiences.push(experience);
                }
            });

            document.querySelectorAll('#certification-set').forEach(set => {
                const certification = set.querySelector('[name="certification"]').value;
                if (certification != "") {
                    information.certifications.push(certification);
                }
            });

            return JSON.stringify(information, null, 2);
        }

        document.getElementById('profile-form').addEventListener('submit', function(event) {
            event.preventDefault();
            const jsonData = getFormDataAsJson();
            const jsonString = JSON.stringify(jsonData);
            console.log(jsonData);

            document.getElementById("pre").style.display = "flex";

            // Fetch request and handling
            fetch('/uploadinfo', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: jsonString
            }).then(response => {
                if (response.ok) {
                    return response.text();
                } else {
                    return response.text().then(text => {
                        throw new Error(text);
                    });
                }
            }).then(data => {
                console.log(data);
                document.getElementById("status").innerText = data;
            }).catch(error => {
                console.error('Error:', error);
                document.getElementById("status").innerText = error.message;
            }).finally(() => {
                document.getElementById("pre").style.display = "none";
                document.getElementById("post").style.display = "flex";
            });
        });


        function addEducation() {
            const education = document.getElementById("education");
            const educationSection = document.getElementById('education-set').cloneNode(true);

            const inputs = educationSection.getElementsByTagName('input');
            for (let i = 0; i < inputs.length; i++) {
                inputs[i].value = '';
            }

            const deleteButton = document.createElement('button');
            deleteButton.textContent = 'Delete';
            deleteButton.className = 'delete-button';
            deleteButton.onclick = function() {
                education.removeChild(educationSection);
            };

            educationSection.appendChild(deleteButton);

            education.appendChild(educationSection);
        }

        function addProject() {
            const project = document.getElementById("projects");
            const projectSection = document.getElementById('project-set').cloneNode(true);

            const inputs = projectSection.getElementsByTagName('input');
            for (let i = 0; i < inputs.length; i++) {
                inputs[i].value = '';
            }

            const deleteButton = document.createElement('button');
            deleteButton.textContent = 'Delete';
            deleteButton.className = 'delete-button';
            deleteButton.onclick = function() {
                project.removeChild(projectSection);
            };

            projectSection.appendChild(deleteButton);

            project.appendChild(projectSection);
        }

        function addPublication() {
            const publications = document.getElementById("publications");
            const publicationSection = document.getElementById('publication-set').cloneNode(true);

            const inputs = publicationSection.getElementsByTagName('input');
            for (let i = 0; i < inputs.length; i++) {
                inputs[i].value = '';
            }

            const deleteButton = document.createElement('button');
            deleteButton.textContent = 'Delete';
            deleteButton.className = 'delete-button';
            deleteButton.onclick = function() {
                publications.removeChild(publicationSection);
            };

            publicationSection.appendChild(deleteButton);

            publications.appendChild(publicationSection);
        }

        function addSkill() {
            const skills = document.getElementById("skill");
            const skillSection = document.getElementById('skill-set').cloneNode(true);

            const input = skillSection.querySelector('input');
            input.value = '';

            const deleteButton = document.createElement('button');
            deleteButton.textContent = 'Delete';
            deleteButton.className = 'delete-button';
            deleteButton.onclick = function() {
                skills.removeChild(skillSection);
            };

            skillSection.appendChild(deleteButton);

            skills.appendChild(skillSection);
        }

        function addLanguage() {
            const languages = document.getElementById("language");
            const languageSection = document.getElementById('language-set').cloneNode(true);

            const input = languageSection.querySelector('input');
            input.value = '';

            const deleteButton = document.createElement('button');
            deleteButton.textContent = 'Delete';
            deleteButton.className = 'delete-button';
            deleteButton.onclick = function() {
                languages.removeChild(languageSection);
            };

            languageSection.appendChild(deleteButton);

            languages.appendChild(languageSection);
        }

        function addAchievements() {
            const achievements = document.getElementById("achievements");
            const achievementSection = document.getElementById('achievements-set').cloneNode(true);

            const input = achievementSection.querySelector('input');
            input.value = '';

            const deleteButton = document.createElement('button');
            deleteButton.textContent = 'Delete';
            deleteButton.className = 'delete-button';
            deleteButton.onclick = function() {
                achievements.removeChild(achievementSection);
            };

            achievementSection.appendChild(deleteButton);

            achievements.appendChild(achievementSection);
        }

        function addAdditional() {
            const additionals = document.getElementById("additional-engagements");
            const additionalSection = document.getElementById('additional-engagements-set').cloneNode(true);

            const input = additionalSection.querySelector('input');
            input.value = '';

            const deleteButton = document.createElement('button');
            deleteButton.textContent = 'Delete';
            deleteButton.className = 'delete-button';
            deleteButton.onclick = function() {
                additionals.removeChild(additionalSection);
            };

            additionalSection.appendChild(deleteButton);

            additionals.appendChild(additionalSection);
        }

        function addWorkExperience() {
            const experiences = document.getElementById("experience");
            const experienceSection = document.getElementById('experience-set').cloneNode(true);

            const input = experienceSection.querySelector('input');
            input.value = '';

            const deleteButton = document.createElement('button');
            deleteButton.textContent = 'Delete';
            deleteButton.className = 'delete-button';
            deleteButton.onclick = function() {
                experiences.removeChild(experienceSection);
            };

            experienceSection.appendChild(deleteButton);

            experiences.appendChild(experienceSection);
        }

        function addCertification() {
            const certifications = document.getElementById("certifications");
            const certificationSection = document.getElementById('certification-set').cloneNode(true);

            const input = certificationSection.querySelector('input');
            input.value = '';

            const deleteButton = document.createElement('button');
            deleteButton.textContent = 'Delete';
            deleteButton.className = 'delete-button';
            deleteButton.onclick = function() {
                certifications.removeChild(certificationSection);
            };

            certificationSection.appendChild(deleteButton);

            certifications.appendChild(certificationSection);
        }
    </script>

</body>
</html>